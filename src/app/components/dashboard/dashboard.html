<div class="dashboard-layout4">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="profile-card">
      <h3>Wlcome back, {{user.displayName}}</h3>
    </div>

    <button class="calendar-toggle-btn" (click)="toggleCalendar()">
      {{ calendarVisible ? 'Hide Calendar' : 'Show Calendar' }}
    </button>

    <div *ngIf="calendarVisible" class="calendar-container">
      <div class="calendar-nav">
        <button (click)="prevMonth()">&laquo; Prev</button>
        <span>{{ currentMonthName }} {{ currentYear }}</span>
        <button (click)="nextMonth()">Next &raquo;</button>
      </div>
      <table class="calendar">
        <thead>
          <tr><th *ngFor="let day of weekDays">{{ day }}</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let week of calendarWeeks">
            <td *ngFor="let dateObj of week"
                [ngClass]="getDateClass(dateObj)"
                (click)="selectDate(dateObj)">
              {{ dateObj.date }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="logout-btn" (click)="logout()">Logout</button>
  </div>

  <!-- MAINLEFT -->
  <div class="mainleft">
    <input type="text"
           [(ngModel)]="searchTerm"
           class="search-bar"
           placeholder="Search tasks..."
           (input)="applySearchFilter()" />

    <div *ngFor="let task of filteredTasks"
         class="task-card"
         [ngClass]="{
           'green-top': task.status,
           'orange-top': isDueWithinTwoDays(task.dueDate, task.status),
           'red-top': isOverdue(task.dueDate, task.status)
         }"
         (click)="showTaskDetails(task)">
      <div class="task-header">
        <div class="task-title">{{ task.title }}</div>
        <div class="task-status">{{ task.status ? '✅ Done' : '⏳ Pending' }}</div>
        <div class="task-duedate">Due: {{ task.dueDate | date:'mediumDate' }}</div>
      </div>
    </div>
  </div>

  <!-- MAINRIGHT -->
  <div class="mainright">

    <!-- Add Task Button -->
    <button class="add-task-btn main-btn" (click)="showAddTaskFormToggle()">
      + Add Task
    </button>

    <!-- Add Task Form -->
    <div *ngIf="showAddTaskForm" class="add-task-form">
      <div *ngIf="createError" class="error-msg">{{ createError }}</div>
      <input type="text" [(ngModel)]="newTask.title" placeholder="Title" />
      <textarea [(ngModel)]="newTask.description" placeholder="Description"></textarea>
      <input type="date" [(ngModel)]="newTask.dueDate" />
      <button class="main-btn" (click)="createTask()">Create</button>
    </div>

    <!-- Task Details -->
    <div *ngIf="selectedTask && !showAddTaskForm" class="task-details-pane">
      <h2 class="detail-title">{{ selectedTask.title }}</h2>

      <div class="dates-status-row">
        <div><strong>Status:</strong> {{ selectedTask.status ? 'Completed' : 'Pending' }}</div>
        <div><strong>Created:</strong> {{ selectedTask.createdAt | date:'short' }}</div>
        <div><strong>Updated:</strong> {{ selectedTask.updatedAt | date:'short' }}</div>
        <div><strong>Due:</strong> {{ selectedTask.dueDate | date:'mediumDate' }}</div>
      </div>

      <div class="task-description">
        <strong>Description:</strong>
        <p>{{ selectedTask.description }}</p>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons" *ngIf="!editMode">
        <button class="main-btn" (click)="startEdit(selectedTask)">Edit</button>
        <button class="delete-btn" (click)="deleteTask(selectedTask.id!)">Delete</button>
        <button class="complete-btn" (click)="toggleComplete(selectedTask)">
          {{ selectedTask.status ? 'Mark Uncomplete' : 'Mark Complete' }}
        </button>
      </div>

      <!-- Edit Form -->
      <div *ngIf="editMode" class="edit-form">
        <div *ngIf="editError" class="error-msg">{{ editError }}</div>
        <input type="text" [(ngModel)]="editTaskData.title" placeholder="Title" />
        <textarea [(ngModel)]="editTaskData.description" placeholder="Description"></textarea>
        <input type="date" [(ngModel)]="editTaskData.dueDate" />
        <div class="form-actions">
          <button class="main-btn" (click)="saveEdit()">Save</button>
          <button class="cancel-btn" (click)="cancelEdit()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="summarybox">
    <div class="current-datetime">
      {{ currentDate | date:'EEEE, MMMM d, y - hh:mm a' }}
    </div>
    <div class="task-summary-box white-bg">
      <h3>Task Summary</h3>
      <div class="summary-line green-line">Completed: {{ completedPercent }}% ({{ completedCount }} tasks)</div>
      <div class="summary-line orange-line">Ongoing: {{ ongoingPercent }}% ({{ ongoingCount }} tasks)</div>
      <div class="summary-line red-line">Out of Date: {{ overduePercent }}% ({{ overdueCount }} tasks)</div>
    </div>
    <div class="streak-box">
      <h4>Streak</h4>
      <div class="streak-star">&#11088;<span class="streak-number"><b>{{ streakCount }}</b></span></div>
    </div>
  </div>
</div>
